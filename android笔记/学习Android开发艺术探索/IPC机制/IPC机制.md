[TOC]



# IPC机制

## 简介

* IPC是Inter-Process Communication的缩写，含义为 进程间通信 或者 跨进程通信，是指两个进程之间进行数据交换的过程。
* 一个进程可以包含多个线程，很多时候，一个进程中需要执行大量耗时的任务，如果这个任务放在主线程中去执行就会造成界面无法响应，严重影响用户体验。在Android中有一个特殊的名字叫做ANR(Applacation Not Responding),即应用无响应。解决这个问题需要用到线程，把耗时操作的任务放在线程中即可；

## Android中的多进程模式

* 因为IPC是进程间通信，那么不了解多进程学个鸡儿IPC;

* 正常情况下，在Android中多进程是指一个应用中存在多个进程的情况；首先，（不讨论特殊情况）在Android中使用多进程只有一种方法，那就是给四大组件（Activity,Service,Receiver,ContentProvider）在AndroidManifest中去指定Android:process属性，也就是说我们无法给一个线程或者一个实体类指定其运行时所在的进程；

* Android:process属性：不指定则在默认进程中；指定则有2中方法指定：

  ~~~java
  //":"的含义是要在当前的进程名前面附加上当前的包名，这是一种简写的方法，还有一种区别，以":"开头的进程属于当前应用的私有进程，其他应用的组件不可以和它跑在同一个进程中；
  Android:process:":remote"
  //下面这种是完整的命名方式，不会附加包名信息；这种进程属于全局进程，其他应用通过ShareUID方式可以和它泡在同一个进程之中；
  Android:process:"com.ryg.chapter_2.com"
  ~~~

* Android里面经常看到却不太留意的知识点——ShareUserId，知道ShareUserId之前，先了解UID，Android系统会为每个应用分配一个唯一的UID，这样权限就被设置成该应用程序的文件只对该用户可见，即只对该应用程序自身可见，而我们可以使他们对其他的应用程序可见，具有相同UID的应用才能分享数据，这会使我们用到SharedUserId，也就是让两个apk使用相同的userID，这样它们就可以看到对方的文件。这里要说明的是，两个应用通过Share UID跑在同一个进程中是有要求的，需要这两个应用有相同的Share UID并且签名相同才可以；为了节省资源，具有相同ID的apk也可以在相同的linux进程中进行(注意，并不是一定要在一个进程里面运行)，共享一个虚拟机。

* Android为每个应用分配了一个独立的虚拟机，或者说为每个进程分配一个独立的虚拟机，不同的虚拟机在内存分配上有不同的地址空间；这就导致了一个问题，在不同的虚拟机中访问同一个类的对象会产生多分副本，并且这些副本之间互不影响，这就是很麻烦的问题；就是说，所有运行在不同进程之间的四大组件，只要它们之间需要通过内存来共享数据，都会失败，这也是多进程所带来的主要影响；

* 一般来说，使用多进程会造成如下几方面的问题：

  1. 静态成员和单例模式完全失效；

  2. 线程同步机制完全失效；（不同进程锁的不是同一个对象）

  3. SharedPreferences的可靠性下降；（因为SharedPreferences不支持两个进程同时去执行写操作，否则会导致一定几率的数据丢失，这是因为SharedPreferences底层是通过读/写XML文件来实现的，并发写显然是可能出问题的；）

  4. Application会多次创建：当一个组件跑在一个新的进程中，由于系统要在创建新的进程同时分配独立的虚拟机，所以这个过程其实就是启动一个应用程序的过程；因此，相当于系统又把这个应用重新启动了一遍；这个问题可以这么理解，运行在同一个进程中的组件是属于同一个虚拟机和同一个Application的，运行在不同进程中的组件是属于两个不同的虚拟机和Application的；

  5. 为了解决多进程所带来的问题，系统还是提供了很多跨进程通信的方法，虽然说不能直接地共享内存，但是通过跨进程通信我们还是可以实现数据交互，比如通过Intent来传递数据，共享文件和SharedPreferences，基于Binder地Messenger和AIDL以及Socket等；

     ​

* 为了更好地理解各种IPC方式，我们需要理解一些概念，比如与序列化相关地Serializable和Parcelable接口，以及Binder的概念（在外面目录下有概念介绍）；

  ​


