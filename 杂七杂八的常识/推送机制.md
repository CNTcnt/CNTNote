[TOC]

# 推送机制

* 推送是移动端非常常见的功能了，就是指的是服务端向指定的客户端推送消息；
* 参考`<https://github.com/hadyang/interview/blob/master/android/push.md>`

## 实现推送主要有两种方法

* 即轮询和长连接

### 轮询

* 轮询指的是客户端隔一段时间就去服务器上获取一下信息，看是否有更新的信息出现。这种方式实现的推送就不是 服务端向指定的客户端推送消息，而是客户端频繁地与服务器创建连接去获取最新消息；
* 我们可以通过`AlarmManager`来管理轮询时间，当然时间的设置策略也是十分重要的，由于每次轮询都需要建立和释放TCP连接非常消耗资源，所以在移动网络情况下耗电量相当大。
* Java下的Timer：WakeLock 让CPU 保持唤醒，耗电量很大；Android下的AlarmManager：管理独立的硬件时钟RTC，可以在CPU休眠的时候正常运行。在预设的时间到达之后，唤醒CPU。这样CPU可以正常休眠，只需要任务到达之后醒来一段很短的时间。
* 针对不同应用的需求，有的可以每5分钟查询一次或者每10分钟查询一次，但是这种策略的电量和流量消耗十分严重。我们可以使用退避法（暂时这么说），比如第一次我们每隔2分钟查询一次数据，如果没有数据，就将查询间隔加倍。
* 轮询：时间短:耗电,耗流量。时间长，不能保证消息及时。

### 长连接

* 客户端主动和服务器建立TCP长连接之后，客户端定期向服务器发送心跳包，有消息的时候，服务器直接通过这个已经建立好的TCP连接通知客户端。
* 长连接就是 建立连接之后，不主动断开。双方互相发送数据，发完了也不主动断开连接，之后有需要发送的数据就继续通过这个连接发送（不用再创建新的连接）。
* 长连接：消息及时，但是要保持住这个长连接不容易
* 看起来这就是最优方案，但是有一个问题，绕不开的 NAT 超时

#### NAT超时

* 由于 IPv4 的IP量有限，运营商分配给手机终端的 IP 其实是运营商内网的 IP，手机要连接 Internet，就需要通过运营商的网关做一个网络地址转换（Network Address Translation，NAT）。简单的说运营商的网关需要维护一个外网 IP、端口到内网 IP、端口的对应关系，以确保内网的手机可以跟 Internet 的服务器通讯。

  [![img](https://github.com/hadyang/interview/raw/master/android/images/push-nat.jpg)](https://github.com/hadyang/interview/blob/master/android/images/push-nat.jpg)

  > NAT 功能由图中的 GGSN 模块实现。

  大部分移动无线网络运营商都在链路一段时间没有数据通讯时，会淘汰 NAT 表中的对应项，造成链路中断。比如我们的长连接要是一直没有数据交互，那么根据淘汰机制会被淘汰掉，那么此连接就为无效连接，我们的客户端就要频繁建立TCP连接，那就和轮询一样太耗能了，那么怎么解决呢？

* 解决方法：解决方法其实很简单，既然长连接要是一直没有数据交互就会被 NAT 判定为超时淘汰，那么只要长连接中一直有数据的交互即可呀，那么是要服务端发还是客户端发数据呢？发送什么数据呢？如果仅仅是为了防止NAT超时，可以让服务器来发送心跳包（空数据）给客户端，不过这样做有个弊病就是，万一连接断了，服务器就再也联系不上客户端了。所以心跳包必须由客户端发送，客户端发现连接断了，还可以尝试重连服务器。

* 还有一个需要解决的问题：我们移动端一直发送心跳包，在使用时自然可以，但是当手机不使用，休眠时也要发送的话，发送心跳包是要唤醒设备才能发送的，那么如果唤醒过于频繁，设备根本没有休眠，这样会大量消耗电量，所以发送心跳包的时间间隔应该尽量长，理想情况下应该比 NAT 超时时间小一点点的事件间隔来发送心跳包。



## 国内android的推送和ios的推送区别

* 首先我们必须知道，所有的推送功能必须有一个客户端和服务器的长连接，因为推送是由服务器主动向客户端发送消息，如果客户端和服务器之间不存在一个长连接那么服务器是无法来主动连接客户端的。因而推送功能都是基于长连接的基础的。

* IOS长连接是由系统来维护的，也就是说苹果的IOS系统在系统级别维护了一个客户端和苹果服务器的长链接，IOS上的所有应用上的推送都是先将消息推送到苹果的服务器然后将苹果服务器通过这个系统级别的长连接推送到手机终端上，这样的的几个好处为：

* 在手机终端始终只要维护一个长连接即可，而且由于这个长连接是系统级别的不会出现被杀死而无法推送的情况。省电，不会出现每个应用都各自维护一个自己的长连接。　安全，只有在苹果注册的开发者才能够进行推送，等等。　

* android的长连接是由每个应用各自维护的（被迫的），google也推出了和苹果技术架构相似的推送框架，C2DM,云端推送功能，但是由于google的服务器不在中国境内，其他的原因你懂的。所以导致这个推送无法使用，android的开发者不得不自己去维护一个长链接，于是每个应用如果都24小时在线，那么都得各自维护一个长连接，这种电量和流量的消耗是可想而知的。虽然国内也出现了各种推送平台，但是都无法达到只维护一个长连接这种消耗的级别。

  

## 使用过的极光推送的注意

* 极光推送针对的是设备，设置的别名是跟设备的 registrationID 绑定。
* 极光是允许为多个 registrationID 设置同个别名的
* 客户端初始化 JPush 成功后，JPush 服务端会分配一个 Registration ID，作为此设备的标识（同一个手机不同 App 的 Registration ID 是不同的）。开发者可以通过指定具体的 Registration ID 来进行对单一设备的推送。

### JPush Android

![jpush_android](https://docs.jiguang.cn/jpush/client/image/jpush_android.png)

* 开发者集成 JPush Android SDK 到其应用里，JPush Android SDK 创建到 JPush Cloud 的长连接，为 App 提供永远在线的能力。 当开发者想要及时地推送消息到达 App 时，只需要调用 JPush API 推送，或者使用其他方便的智能推送工具，即可轻松与用户交流。

* 图中红色部分，是 JPush 与 App 开发者的接触点。手机客户端侧，App 需要集成 JPush SDK；服务器端部分，开发者调用 JPush REST API 来进行推送。

### Android SDK 服务

* JPush Android SDK 是作为 Android Service 长期运行在后台的，从而创建并保持长连接，保持永远在线的能力。